<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Yolluk YÃ¶netim Sistemi Serhan SAYGIN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      :root {
        --bg: radial-gradient(circle at 20% 20%, #0d1117 0%, #000 100%);
        --card: rgba(255,255,255,0.08);
        --accent: #00f6d2;
        --accent-glow: 0 0 15px rgba(0,246,210,.6);
        --text: #e2e8f0;
        --muted: #8b9cb3;
        --border: rgba(255,255,255,0.15);
        --danger: #ff4757;
        --success: #2ecc71;
        --warning: #f1c40f;
      }
      * { box-sizing:border-box; font-family: 'Segoe UI', Inter, sans-serif; }
      
      /* EKRAN MODU */
      body { margin:0; min-height:100vh; background:var(--bg); color:var(--text); display:flex; justify-content:center; padding:20px; }
      .app { width:100%; max-width:1450px; }
      
      /* --- Ã–NEMLÄ°: YazdÄ±rma alanÄ± normal ekranda GÃ–RÃœNMEZ --- */
      #print-area { display: none; }

      header { display:flex; justify-content:space-between; align-items:center; padding:15px; border-radius:18px; background:var(--card); box-shadow: var(--accent-glow); margin-bottom:20px; border: 1px solid var(--border); }
      .header-left img, .right-images img { height:65px; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,0.5); }
      .header-center h1 { margin:0; font-size:22px; color:var(--accent); text-transform: uppercase; text-shadow: var(--accent-glow); }
      .main-container { padding:20px; border-radius:16px; background:var(--card); border: 1px solid var(--border); backdrop-filter:blur(20px); }
      .card-section { background: rgba(0,0,0,0.4); padding: 18px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
      h3 { color: var(--accent); margin-top: 0; margin-bottom: 0; font-size: 15px; text-transform: uppercase; }
      h4 { color: var(--warning); margin: 15px 0 5px 0; font-size: 13px; border-left: 3px solid var(--warning); padding-left: 10px; }
      input, select { background: #0d1117 !important; color: #fff !important; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin: 5px 0; width: 100%; outline: none; }
      .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; text-transform: uppercase; font-size: 10px; }
      .btn-primary { background: var(--accent); color: #000; }
      .btn-danger { background: var(--danger); color: #fff; }
      .btn-warning { background: var(--warning); color: #000; }
      .btn-success { background: var(--success); color: #000; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
      th { text-align: left; color: var(--accent); border-bottom: 1px solid var(--border); padding: 10px; font-size: 12px; cursor: pointer; }
      td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; vertical-align: middle; }
      .tag { background: rgba(0,246,210,0.1); color: var(--accent); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--accent); margin: 3px; font-size: 10px; display: inline-flex; align-items:center; gap:5px; }
      .hidden { display: none !important; }
      footer { margin-top:20px; padding: 15px; border-top: 1px solid var(--border); color: var(--accent); font-weight: bold; }
      .filter-area { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
      .filter-area select, .filter-area input { width: auto; display: inline-block; margin: 0; }
      .task-filter { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
      
      /* --- YAZDIRMA MODU (SADECE YAZICIDA GÃ–RÃœNÃœR) --- */
      @media print {
        /* Uygulama ekranÄ±nÄ± tamamen yok et (BoÅŸ sayfa iÃ§in) */
        .app { display: none !important; }
        
        /* Sayfa ayarlarÄ±nÄ± sÄ±fÄ±rla */
        body { margin: 0 !important; padding: 0 !important; background-color: white !important; height: 100%; }

        /* YazdÄ±rma AlanÄ±nÄ± GÃ¶ster ve SOL ALT KÃ–ÅEYE KonumlandÄ±r */
        #print-area {
            display: block !important;
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 350px;
            background-color: transparent !important;
            color: black !important;
            font-family: 'Arial', sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            z-index: 99999;
            
            /* Siyah Ã‡erÃ§eve */
            border: 2px solid #000;
            padding: 15px;
            border-radius: 0;
        }

        #print-area * {
            color: black !important;
            visibility: visible !important;
        }
        
        #print-area h1 { font-size: 11pt; margin: 0 0 10px 0; text-decoration: underline; font-weight: bold; text-align: left; }
        #print-area h2 { font-size: 9pt; margin: 0 0 10px 0; font-weight: normal; text-align: left; }
        #print-area .line { margin-bottom: 5px; }
        #print-area .bold { font-weight: bold; }
      }
    </style>
</head>
<body>
  
  <div id="print-area"></div>

  <div class="app">
    <header>
      <div class="header-left">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b4/Flag_of_Turkey.svg">
        <img src="https://upload.wikimedia.org/wikipedia/commons/f/f8/Flag_of_the_Customs_Administration_of_Turkey.svg">
      </div>
      <div class="header-center">
        <h1>Yolluk YÃ¶netim Sistemi</h1>
        <p id="user-display">GiriÅŸ Bekleniyor...</p>
      </div>
      <div class="header-right">
        <div class="right-images">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/61/G%C3%9CMR%C3%9CK_%C4%B0LK_LOGOlogo.png">
          <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/T.C._G%C3%9CMR%C3%9CKLER%C4%B0_TURKISH_CUSTOMS..png">
          <img src="https://i.pinimg.com/1200x/b7/3f/34/b73f34bfd2705436fb27183f5ad3d665.jpg">
        </div>
      </div>
    </header>

    <div class="main-container">
      <div id="login-screen">
        <div style="max-width:320px; margin: 50px auto; text-align: center;">
          <h3 style="color:var(--accent); border-bottom:1px solid var(--border); padding-bottom:10px;">GÃ¼venli GiriÅŸ</h3>
          <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
          <input type="password" id="password" placeholder="Åifre">
          <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="app.login()">SÄ°STEME GÄ°R</button>
        </div>
      </div>

      <div id="panel-content" class="hidden">
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
            <button class="btn btn-danger" onclick="localStorage.removeItem('currentUser'); location.reload();">Ã‡IKIÅ YAP</button>
            <button class="btn btn-warning" onclick="app.changePassword()">ÅÄ°FRE DEÄÄ°ÅTÄ°R</button>
            
            <div id="admin-toggle-area" class="hidden">
                <label style="font-size:12px; color:var(--warning)">ÅEF ONAYINI DEVRE DIÅI BIRAK:</label>
                <input type="checkbox" id="bypass-sef" style="width:auto;" onchange="app.db.bypassSef = this.checked; app.save()">
            </div>
        </div>

        <div id="stats-section" class="card-section">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">
                <h3 style="border:none; padding:0; margin:0;">ğŸ“Š Personel HakediÅŸ & Adalet Tablosu</h3>
                <button class="btn btn-primary" onclick="app.exportSummaryExcel()">Ã–ZETÄ° EXCEL AKTAR</button>
            </div>

            <div class="filter-area">
                <label style="color:var(--accent); margin-right:5px;">Ay:</label>
                <select id="ay-filtre" onchange="app.seciliAy = this.value; app.render()" style="width:140px;"></select>
                
                <label style="color:var(--warning); margin-left:10px;">SÄ±ralama:</label>
                <select id="sort-filtre" onchange="app.render()" style="width:160px;">
                    <option value="yolluk-az">ğŸ’° Yolluk: Azdan Ã‡oÄŸa</option>
                    <option value="yolluk-cok">ğŸ’° Yolluk: Ã‡oktan Aza</option>
                    <option value="isim-az">ğŸ”¤ Ä°sim: A-Z</option>
                </select>

                <div id="month-totals" style="margin-left:15px; font-size:11px; background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:6px; border:1px solid var(--border);"></div>
            </div>
            
            <h4>GÃœMRÃœK</h4>
            <table><thead><tr><th>Sicil</th><th>Ad Soyad</th><th>Ãœnvan</th><th>Mesai</th><th>Yolluk</th><th>Toplam</th></tr></thead><tbody id="stats-gumruk"></tbody></table>
            <h4>MUHAFAZA</h4>
            <table><thead><tr><th>Sicil</th><th>Ad Soyad</th><th>Ãœnvan</th><th>Mesai</th><th>Yolluk</th><th>Toplam</th></tr></thead><tbody id="stats-muhafaza"></tbody></table>
            <h4>KÄ°M</h4>
            <table><thead><tr><th>Sicil</th><th>Ad Soyad</th><th>Ãœnvan</th><th>Mesai</th><th>Yolluk</th><th>Toplam</th></tr></thead><tbody id="stats-kim"></tbody></table>
        </div>

        <div id="ps-panel" class="card-section hidden" style="border: 1px solid var(--success);">
            <h3 style="color:var(--success); border-bottom:1px solid var(--success); padding-bottom:8px;">ğŸ¥ Personel Ä°zin & Rapor Takibi</h3>
            <p style="font-size:11px; color:var(--muted)">Buradan girilen izinli/raporlu personellere, ilgili tarihlerde gÃ¶rev yazÄ±lamaz.</p>
            
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap:10px; margin-top:10px;">
                <select id="ps-personel-select"></select>
                <input type="date" id="ps-baslangic" placeholder="BaÅŸlangÄ±Ã§">
                <input type="date" id="ps-bitis" placeholder="BitiÅŸ">
                <select id="ps-tur"><option>YÄ±llÄ±k Ä°zin</option><option>SÄ±hhi Rapor</option><option>Mazeret Ä°zni</option><option>GÃ¶revli</option></select>
                <button class="btn btn-success" onclick="app.addLeave()">KAYDET</button>
            </div>

            <h4 style="margin-top:20px;">AKTÄ°F Ä°ZÄ°N/RAPOR LÄ°STESÄ°</h4>
            <table>
                <thead><tr><th>Personel</th><th>BaÅŸlangÄ±Ã§</th><th>BitiÅŸ</th><th>TÃ¼r</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="leave-list-body"></tbody>
            </table>
        </div>

        <div id="admin-section" class="hidden">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="card-section">
                    <h3 style="border-bottom:1px solid var(--border); padding-bottom:8px;">Personel KayÄ±t & DÃ¼zenleme</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                        <input type="text" id="p-sicil" placeholder="Sicil">
                        <input type="text" id="p-ad" placeholder="Ad Soyad">
                        <select id="p-birim">
                            <option value="GÃ¼mrÃ¼k">GÃ¼mrÃ¼k</option>
                            <option value="Muhafaza">Muhafaza</option>
                            <option value="KÄ°M">KÄ°M</option>
                        </select>
                        <select id="p-unvan">
                            <option>GÃ¼mrÃ¼k Memuru</option><option>GÃ¼mrÃ¼k Muayene Memuru</option><option>GÃ¼mrÃ¼k Muhafaza Memuru</option>
                            <option>GÃ¼mrÃ¼k Åefi</option><option>KÄ±sÄ±m Amiri</option><option>BÃ¶lge Amiri</option>
                            <option>GÃ¼mrÃ¼k MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option><option>GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼</option><option>KÄ°M MÃ¼dÃ¼rÃ¼</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="app.addPersonel()">YENÄ° PERSONEL EKLE</button>
                    <div style="max-height: 300px; overflow-y: auto; margin-top:10px; border-top:1px solid var(--border);">
                        <table style="font-size:10px;"><tbody id="p-manage-body"></tbody></table>
                    </div>
                </div>
                <div class="card-section">
                    <h3 style="border-bottom:1px solid var(--border); padding-bottom:8px;">Hizmet Ãœcret Kalemleri</h3>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="y-ad" placeholder="Gemi Mesaisi vb.">
                        <input type="number" id="y-tutar" placeholder="TL">
                        <select id="y-tip" style="width:80px"><option>Mesai</option><option>Yolluk</option></select>
                        <button class="btn btn-primary" onclick="app.addYolluk()">KAYDET</button>
                    </div>
                    <div id="y-list" style="margin-top:10px;"></div>
                </div>
            </div>

            <div class="card-section">
                <h3 style="border-bottom:1px solid var(--border); padding-bottom:8px;">Sistem GiriÅŸ Yetkileri (KullanÄ±cÄ±lar)</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:5px; margin-bottom:10px;">
                    <input type="text" id="acc-user" placeholder="Yeni KullanÄ±cÄ± AdÄ±">
                    <input type="password" id="acc-pass" placeholder="Åifre">
                    <select id="acc-rol">
                        <option>Admin</option>
                        <option>GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼</option>
                        <option>GÃ¼mrÃ¼k MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
                        <option>GÃ¼mrÃ¼k Åefi</option>
                        <option>GÃ¼mrÃ¼k Memuru</option>
                        <option>Personel Servisi</option>
                    </select>
                    <button class="btn btn-primary" onclick="app.addAccount()">YETKÄ° VER / EKLE</button>
                </div>
                <table style="width:100%; font-size:11px;">
                    <thead><tr style="text-align:left; color:var(--accent);"><th>KullanÄ±cÄ± AdÄ±</th><th>Åifre</th><th>Yetki RolÃ¼</th><th>Ä°ÅŸlem</th></tr></thead>
                    <tbody id="acc-list-body"></tbody>
                </table>
            </div>
        </div>

        <div id="record-section" class="card-section hidden">
            <h3 style="border-bottom:1px solid var(--border); padding-bottom:8px;">GÃ¶revlendirme Formu</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                <div>GÃ¼mrÃ¼k Personelleri<select id="sel-g" multiple size="8" onchange="app.selectMultiple(this)"></select></div>
                <div>Muhafaza Personelleri<select id="sel-m" multiple size="8" onchange="app.selectMultiple(this)"></select></div>
                <div>KÄ°M Personelleri<select id="sel-k" multiple size="8" onchange="app.selectMultiple(this)"></select></div>
            </div>
            <div id="selected-list" style="margin: 10px 0; padding:10px; border:1px dashed var(--border); border-radius:8px;"></div>
            <div style="margin-top:10px;">
                <button class="btn btn-danger" style="font-size:10px; padding:5px 10px;" onclick="app.selectedPs=[]; app.render()">TÃœM SEÃ‡Ä°LENLERÄ° TEMÄ°ZLE</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:15px; margin-top:10px;">
                <div>
                    <label style="font-size:11px; color:var(--accent)">HakediÅŸ Kalemleri (CTRL ile Ã‡oklu SeÃ§im):</label>
                    <select id="task-types" multiple style="height:110px"></select>
                    
                    <div style="margin-top:5px; padding-top:5px; border-top:1px dashed var(--border);">
                        <label style="font-size:10px; color:var(--warning)">+ Manuel Tutar Ekle:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="manual-tutar" placeholder="Tutar (TL)" style="font-size:11px;">
                            <select id="manual-tip" style="font-size:11px;"><option value="Mesai">Mesai</option><option value="Yolluk">Yolluk</option></select>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="font-size:11px; color:var(--accent)">Beyanname / Karar / Referans No:</label>
                    <input type="text" id="task-no" placeholder="Evrak No Girin">
                    <button class="btn btn-primary" style="width:100%; height:42px; margin-top:10px;" onclick="app.saveTask()">GÃ–REVÄ° KAYDET VE HAVALE ET</button>
                </div>
            </div>
        </div>

        <div class="card-section" id="task-list-section">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">
                <h3 style="border:none; padding:0; margin:0;">Ä°ÅŸlem Takip Listesi</h3>
                <button class="btn btn-primary" onclick="app.exportTaskListExcel()">LÄ°STEYÄ° EXCEL AKTAR</button>
            </div>
            
            <div class="task-filter">
                <input type="text" id="search-text" placeholder="Arama (Ad, Ref, Evrak No)" onkeyup="app.taskFilter.arama = this.value; app.render()">
                <select id="durum-filter" onchange="app.taskFilter.durum = this.value; app.render()">
                    <option value="">TÃ¼m Durumlar</option>
                    <option>Taslak</option><option>Åef OnayÄ±nda</option><option>MÃ¼dÃ¼r Yrd. OnayÄ±nda</option><option>OnaylandÄ±</option><option>Reddedildi</option><option>Silme Talebinde</option>
                </select>
                <input type="month" id="tarih-baslangic" onchange="app.taskFilter.baslangic = this.value; app.render()">
                <input type="month" id="tarih-bitis" onchange="app.taskFilter.bitis = this.value; app.render()">
                <button class="btn btn-warning" style="font-size:9px;" onclick="app.taskFilter = {arama:'', durum:'', baslangic:'', bitis:''}; document.getElementById('search-text').value=''; document.getElementById('durum-filter').value=''; document.getElementById('tarih-baslangic').value=''; document.getElementById('tarih-bitis').value=''; app.render()">FÄ°LTREYÄ° TEMÄ°ZLE</button>
            </div>
            <table>
                <thead><tr><th>Referans</th><th>Evrak No</th><th>GÃ¶revliler</th><th>Tutar DetayÄ± ("YardÄ±r")</th><th>Durum</th><th>EBYS</th><th>Dekont</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="main-list"></tbody>
            </table>
        </div>
      </div>
    </div>

    <div id="print-area"></div>

    <footer>
    <a href="https://www.linkedin.com/in/serhansaygin/" target="_blank" style="color: var(--accent); text-decoration: none;">
        Serhan SAYGIN â€” GÃ¼mrÃ¼k Memuru
    </a>
</footer>

  <script>
    const app = {
        // VeritabanÄ± baÄŸlantÄ±sÄ± ve eski verilerin korunmasÄ±
        db: JSON.parse(localStorage.getItem('gumruk_final_v60')) || {
            accounts: [
                {rol: "Admin", user: "Admin", pass: "admin123"},
                {rol: "GÃ¼mrÃ¼k Åefi", user: "Åef1", pass: "123"},
                {rol: "GÃ¼mrÃ¼k Memuru", user: "Memur1", pass: "123"},
                {rol: "GÃ¼mrÃ¼k MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±", user: "MÃ¼dÃ¼rYrd1", pass: "123"},
                {rol: "GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼", user: "Mudur", pass: "123"},
                {rol: "Personel Servisi", user: "Pers", pass: "123"}
            ],
            personeller: [], yolluklar: [], kayitlar: [], izinler: [], 
            bypassSef: false
        },
        user: null,
        selectedPs: [],
        seciliAy: null,
        taskFilter: {arama: '', durum: '', baslangic: '', bitis: ''},
        unvanlar: ["GÃ¼mrÃ¼k Memuru", "GÃ¼mrÃ¼k Muayene Memuru", "GÃ¼mrÃ¼k Muhafaza Memuru", "GÃ¼mrÃ¼k Åefi", "KÄ±sÄ±m Amiri", "BÃ¶lge Amiri", "GÃ¼mrÃ¼k MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±", "GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼", "KÄ°M MÃ¼dÃ¼rÃ¼"],

        login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const acc = this.db.accounts.find(x => x.user === u && x.pass === p);
            if(acc) {
                this.user = acc;
                localStorage.setItem('currentUser', JSON.stringify(this.user));

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('panel-content').classList.remove('hidden');
                document.getElementById('user-display').innerText = `Yetkili: ${acc.user} (${acc.rol})`;

                // Rol kontrolleri
                const r = acc.rol;
                document.getElementById('admin-section').classList.add('hidden');
                document.getElementById('admin-toggle-area').classList.add('hidden');
                document.getElementById('record-section').classList.add('hidden');
                document.getElementById('task-list-section').classList.add('hidden');
                document.getElementById('stats-section').classList.add('hidden');
                document.getElementById('ps-panel').classList.add('hidden');

                if(r === 'Admin') {
                    document.getElementById('admin-section').classList.remove('hidden');
                    document.getElementById('admin-toggle-area').classList.remove('hidden');
                    document.getElementById('record-section').classList.remove('hidden');
                    document.getElementById('task-list-section').classList.remove('hidden');
                    document.getElementById('stats-section').classList.remove('hidden');
                    document.getElementById('ps-panel').classList.remove('hidden');
                } 
                else if (r === 'Personel Servisi') {
                    document.getElementById('ps-panel').classList.remove('hidden');
                }
                else {
                    document.getElementById('record-section').classList.remove('hidden');
                    document.getElementById('task-list-section').classList.remove('hidden');
                    document.getElementById('stats-section').classList.remove('hidden');
                }

                if(r === 'GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼') document.getElementById('admin-section').classList.add('hidden');

                this.render();
            } else alert("KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!");
        },

        checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                this.user = JSON.parse(savedUser);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('panel-content').classList.remove('hidden');
                document.getElementById('user-display').innerText = `Yetkili: ${this.user.user} (${this.user.rol})`;
                
                const r = this.user.rol;
                // AynÄ± rol kontrolleri burada da (kÄ±salÄ±k iÃ§in tekrar yazmÄ±yorum, login ile aynÄ± mantÄ±k iÅŸler)
                document.getElementById('admin-section').classList.add('hidden');
                document.getElementById('admin-toggle-area').classList.add('hidden');
                document.getElementById('record-section').classList.add('hidden');
                document.getElementById('task-list-section').classList.add('hidden');
                document.getElementById('stats-section').classList.add('hidden');
                document.getElementById('ps-panel').classList.add('hidden');

                if(r === 'Admin') {
                    document.getElementById('admin-section').classList.remove('hidden');
                    document.getElementById('admin-toggle-area').classList.remove('hidden');
                    document.getElementById('record-section').classList.remove('hidden');
                    document.getElementById('task-list-section').classList.remove('hidden');
                    document.getElementById('stats-section').classList.remove('hidden');
                    document.getElementById('ps-panel').classList.remove('hidden');
                } 
                else if (r === 'Personel Servisi') {
                    document.getElementById('ps-panel').classList.remove('hidden');
                }
                else {
                    document.getElementById('record-section').classList.remove('hidden');
                    document.getElementById('task-list-section').classList.remove('hidden');
                    document.getElementById('stats-section').classList.remove('hidden');
                }
                this.render();
            }
        },

       changePassword() {
            if (!this.user) return alert("GiriÅŸ yapmadÄ±nÄ±z!");
            const yeni = prompt("Yeni ÅŸifrenizi girin:");
            if (yeni && yeni.trim() !== "") {
                const accIndex = this.db.accounts.findIndex(x => x.user === this.user.user);
                if (accIndex > -1) {
                    this.db.accounts[accIndex].pass = yeni.trim();
                    this.user.pass = yeni.trim();
                    this.save();
                    alert("Åifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi!");
                }
            } else {
                alert("Åifre boÅŸ olamaz!");
            }
        },

        selectMultiple(el) {
            const selectedOptions = Array.from(el.selectedOptions).map(opt => opt.value);
            selectedOptions.forEach(value => {
                if (value && !this.selectedPs.includes(value)) {
                    this.selectedPs.push(value);
                }
            });
            el.selectedIndex = -1;
            this.render();
        },

        addPersonel() {
            const s = document.getElementById('p-sicil').value.trim();
            const a = document.getElementById('p-ad').value.trim();
            const b = document.getElementById('p-birim').value;
            const u = document.getElementById('p-unvan').value;
            if(s && a) { 
                this.db.personeller.push({sicil:s, ad:a, birim:b, unvan:u}); 
                this.save(); 
            }
        },

        addYolluk() {
            const ad = document.getElementById('y-ad').value.trim();
            const tutar = document.getElementById('y-tutar').value;
            const tip = document.getElementById('y-tip').value;
            if(ad && tutar && !isNaN(tutar)) { 
                this.db.yolluklar.push({ad: ad, tutar: parseFloat(tutar), tip: tip}); 
                document.getElementById('y-ad').value = "";
                document.getElementById('y-tutar').value = "";
                this.save(); 
            } else {
                alert("LÃ¼tfen geÃ§erli bir kalem adÄ± ve tutar girin!");
            }
        },

        addAccount() {
            const u = document.getElementById('acc-user').value.trim();
            const p = document.getElementById('acc-pass').value;
            const r = document.getElementById('acc-rol').value;
            if (!u || !p) { alert("KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz!"); return; }
            if (this.db.accounts.some(acc => acc.user === u)) { alert("Bu kullanÄ±cÄ± adÄ± zaten mevcut!"); return; }
            this.db.accounts.push({ user: u, pass: p, rol: r });
            this.render(); this.save(); alert("KullanÄ±cÄ± eklendi!");
        },

        deleteAccount(index) {
            if (confirm("Silmek istediÄŸinize emin misiniz?")) {
                this.db.accounts.splice(index, 1);
                this.render(); this.save();
            }
        },

        addLeave() {
            const p = document.getElementById('ps-personel-select').value;
            const bas = document.getElementById('ps-baslangic').value;
            const bit = document.getElementById('ps-bitis').value;
            const tur = document.getElementById('ps-tur').value;

            if(!p || !bas || !bit) return alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
            if(bas > bit) return alert("BaÅŸlangÄ±Ã§ tarihi bitiÅŸten bÃ¼yÃ¼k olamaz!");

            if(!this.db.izinler) this.db.izinler = [];
            this.db.izinler.push({ personel: p, baslangic: bas, bitis: bit, tur: tur });
            this.save();
            alert("Ä°zin/Rapor kaydÄ± baÅŸarÄ±yla oluÅŸturuldu.");
        },

        deleteLeave(index) {
            if(confirm("Silmek istiyor musunuz?")) {
                this.db.izinler.splice(index, 1);
                this.save();
            }
        },

        checkConflict(personel) {
            if (!this.db.izinler) return null;
            const today = new Date().toISOString().slice(0, 10);
            return this.db.izinler.find(i => i.personel === personel && today >= i.baslangic && today <= i.bitis);
        },

        generateRef() {
            const d = new Date();
            const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const prefix = `GM-${dateStr}/`; 
            const todaysRecords = this.db.kayitlar.filter(k => k.ref && k.ref.startsWith(prefix));
            if (todaysRecords.length === 0) return prefix + "1"; 
            const sequenceNumbers = todaysRecords.map(k => {
                const parts = k.ref.split('/');
                return parseInt(parts[1]) || 0; 
            });
            const maxSeq = Math.max(...sequenceNumbers);
            return prefix + (maxSeq + 1); 
        },

        saveTask() {
            const selTypes = Array.from(document.getElementById('task-types').selectedOptions).map(o => this.db.yolluklar[o.value]);
            const manualTutar = parseFloat(document.getElementById('manual-tutar').value) || 0;
            const manualTip = document.getElementById('manual-tip').value;

            if(this.selectedPs.length === 0 || (selTypes.length === 0 && manualTutar === 0)) return alert("Hata: Personel ve en az bir Ã¼cret girilmelidir!");
            
            for (let p of this.selectedPs) {
                const conflict = this.checkConflict(p);
                if (conflict) {
                    alert(`HOOP! ğŸ›‘\n\n${p} isimli personel ÅŸu an "${conflict.tur}" sebebiyle izinli/raporlu!\n(${conflict.baslangic} - ${conflict.bitis})\n\nGÃ¶rev yazÄ±lamaz.`);
                    return; 
                }
            }

            const personelSayisi = this.selectedPs.length;
            let toplamMesai = 0, toplamYolluk = 0;
            
            selTypes.forEach(t => {
                if (t.tip === "Mesai") toplamMesai += t.tutar;
                else toplamYolluk += t.tutar;
            });

            if (manualTutar > 0) {
                if (manualTip === "Mesai") toplamMesai += manualTutar;
                else toplamYolluk += manualTutar;
            }

            const isYonetici = (this.user.rol === 'Admin' || this.user.rol.includes('MÃ¼dÃ¼r'));
            const ilkDurum = isYonetici ? "OnaylandÄ±" : (this.db.bypassSef ? "MÃ¼dÃ¼r Yrd. OnayÄ±nda" : "Taslak");

            const now = new Date();
            const ayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            this.db.kayitlar.push({
                ref: this.generateRef(),
                no: document.getElementById('task-no').value || "Belirtilmedi",
                personeller: [...this.selectedPs],
                personelSayisi: personelSayisi,
                toplamMesai: toplamMesai,
                toplamYolluk: toplamYolluk,
                mTotal: toplamMesai, 
                yTotal: toplamYolluk,
                durum: ilkDurum,
                ebys: "", 
                dekont: "",
                tarih: ayStr
            });
            
            this.selectedPs = [];
            document.getElementById('manual-tutar').value = "";
            this.save();
        },

        deleteTask(ref) {
            if(confirm("Bu iÅŸlem geri alÄ±namaz. KaydÄ± silmek istediÄŸinize emin misiniz?")) {
                this.db.kayitlar = this.db.kayitlar.filter(x => String(x.ref) !== String(ref));
                this.save();
            }
        },

        process(ref, s) { 
            this.db.kayitlar.find(x=>x.ref===ref).durum = s; 
            this.save(); 
        },

        updateExtra(ref, key) {
            const v = prompt(`${key} No Giriniz:`);
            if(v) { 
                this.db.kayitlar.find(x=>x.ref===ref)[key.toLowerCase()] = v; 
                this.save(); 
            }
        },

        // --- DÃœZELTÄ°LMÄ°Å YAZDIRMA FONKSÄ°YONU ---
        printDoc(ref) {
            const l = this.db.kayitlar.find(x => x.ref === ref);
            const area = document.getElementById('print-area');
            const m = l.mTotal || l.toplamMesai;
            const y = l.yTotal || l.toplamYolluk;
            const total = m + y;

            const smallStyle = 'font-size: 9pt;'; 

            let breakdownHtml = "";
            if(y > 0 && m === 0) breakdownHtml += `<div class="line">YOLLUK: <span class="bold">${y.toFixed(2)} TL</span></div>`;
            if(m > 0 && y === 0) breakdownHtml += `<div class="line">FAZLA Ã‡ALIÅMA (MESAÄ°): <span class="bold">${m.toFixed(2)} TL</span></div>`;
            
            if(y > 0 && m > 0) {
                 breakdownHtml = `
                    <div class="line">YOLLUK: ${y.toFixed(2)} TL</div>
                    <div class="line">FAZLA Ã‡ALIÅMA (MESAÄ°): ${m.toFixed(2)} TL</div>
                    <div class="line" style="border-top:1px solid #000; padding-top:2px;">TOPLAM: <span class="bold">${total.toFixed(2)} TL</span></div>
                 `;
            }

            // Ä°Ã§eriÄŸi Doldur (Ama ekranda GÄ°ZLÄ° kalacak, CSS @media print gÃ¶sterecek)
            area.innerHTML = `
                <h1>GÃ–REV VE TAHAKKUK FORMU</h1>
                <h2>REF: ${l.ref}</h2>
                <div class="line"><strong>GÃ–REVLÄ°LER:</strong></div>
                ${l.personeller.map(p => {
                    const d = this.db.personeller.find(x => x.ad === p);
                    return `<div class="line">- ${d ? d.sicil : ''} ${p} (${d ? d.unvan : ''})</div>`;
                }).join('')}
                <div class="line" style="margin-top:10px;">Evrak No: ${l.no}</div>
                ${breakdownHtml}
                <div class="line" style="margin-top:10px;">EBYS: ${l.ebys || '_______'} | DEKONT: ${l.dekont || '_______'}</div>
                <div class="line" style="margin-top:15px;">ONAYLAYAN<br>....................</div>
                <div class="line" style="margin-top:5px; font-size:8pt;">${new Date().toLocaleDateString('tr-TR')}</div>
            `;

            // YazdÄ±rma komutu
            window.print();
        },

        mevcutAy() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        },

        mevcutAylar() {
            const aylar = [...new Set(this.db.kayitlar.filter(k => k.durum === "OnaylandÄ±" && k.tarih).map(k => k.tarih))];
            aylar.sort((a,b) => b.localeCompare(a));
            return aylar.length > 0 ? aylar : [this.mevcutAy()];
        },

        save() { 
            localStorage.setItem('gumruk_final_v60', JSON.stringify(this.db)); 
            this.render(); 
            // Bulut Yedekleme 
            const scriptURL = 'https://script.google.com/macros/s/AKfycbw_N1yCCR_onmZI3i8xMVLgkfV0j1UqRzMN7WHOT8wqTSJW_mQtzqA853FVLtu03n-E/exec';            
            fetch(scriptURL, {
                method: 'POST',
                cache: 'no-cache',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    user: this.user ? this.user.user : 'Sistem',
                    action: 'Veri Yedekleme',
                    payload: this.db
                })
            }).then(r=>r.json()).then(d=>console.log("Bulut OK", d)).catch(e=>console.log("Bulut Err", e));
        },

        loadFromCloud() {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbw_N1yCCR_onmZI3i8xMVLgkfV0j1UqRzMN7WHOT8wqTSJW_mQtzqA853FVLtu03n-E/exec';
            fetch(scriptURL).then(res => res.text()).then(data => {
                if (data && data.trim() !== "" && data !== "null") {
                    try {
                        const cloudData = JSON.parse(data);
                        if (cloudData && Array.isArray(cloudData.kayitlar)) {
                            this.db = cloudData;
                            localStorage.setItem('gumruk_final_v60', data);
                            this.render();
                        }
                    } catch(e) { console.error("Bulut hatasÄ±:", e); }
                }
            });
        },

        render() {
            const opt = (b) => this.db.personeller.filter(x => x.birim === b).map(p => {
                const selected = this.selectedPs.includes(p.ad) ? ' selected' : '';
                return `<option value="${p.ad}"${selected}>${p.ad} (${p.unvan})</option>`;
            }).join('');
            
            if(document.getElementById('sel-g')) {
                document.getElementById('sel-g').innerHTML = opt('GÃ¼mrÃ¼k');
                document.getElementById('sel-m').innerHTML = opt('Muhafaza');
                document.getElementById('sel-k').innerHTML = opt('KÄ°M');
                document.getElementById('task-types').innerHTML = this.db.yolluklar.map((y,i)=>`<option value="${i}">${y.ad} (${y.tip} - ${y.tutar} TL)</option>`).join('');
                
                const allP = this.db.personeller.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
                document.getElementById('ps-personel-select').innerHTML = allP;
            }
            if(document.getElementById('selected-list')) {
                document.getElementById('selected-list').innerHTML = this.selectedPs.map(p => `<span class="tag">${p} <b onclick="app.selectedPs=app.selectedPs.filter(x=>x!=='${p}');app.render()" style="cursor:pointer;color:red">X</b></span>`).join('');
            }

            if (document.getElementById('ay-filtre')) {
                if (!this.seciliAy) this.seciliAy = this.mevcutAy();
                const aylar = this.mevcutAylar();
                const ayIsimleri = {"01":"Ocak","02":"Åubat","03":"Mart","04":"Nisan","05":"MayÄ±s","06":"Haziran","07":"Temmuz","08":"AÄŸustos","09":"EylÃ¼l","10":"Ekim","11":"KasÄ±m","12":"AralÄ±k"};
                document.getElementById('ay-filtre').innerHTML = aylar.map(ay => {
                    const [y, m] = ay.split('-');
                    return `<option value="${ay}" ${ay === this.seciliAy ? 'selected' : ''}>${ayIsimleri[m]} ${y}</option>`;
                }).join('');
            }

            if(document.getElementById('leave-list-body')) {
                const leaveData = this.db.izinler || [];
                document.getElementById('leave-list-body').innerHTML = leaveData.length > 0 ? leaveData.map((l, i) => `
                    <tr>
                        <td><b>${l.personel}</b></td>
                        <td>${l.baslangic}</td>
                        <td>${l.bitis}</td>
                        <td><span class="tag" style="background:#e74c3c33; color:#e74c3c; border-color:#e74c3c;">${l.tur}</span></td>
                        <td><button class="btn btn-danger" style="font-size:9px;" onclick="app.deleteLeave(${i})">SÄ°L</button></td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align:center; color:#666;">Aktif izin/rapor kaydÄ± yok.</td></tr>';
            }

            const hedefAy = this.seciliAy || this.mevcutAy();
            let ayinToplamYollugu = 0;
            let ayinToplamMesaisi = 0;

            const hakedisVerisi = this.db.personeller.map(p => {
                let m = 0, y = 0;
                this.db.kayitlar.filter(k => k.durum === "OnaylandÄ±" && k.tarih === hedefAy).forEach(k => {
                    if (k.personeller.includes(p.ad)) {
                        m += (k.mTotal || k.toplamMesai) / k.personelSayisi;
                        y += (k.yTotal || k.toplamYolluk) / k.personelSayisi;
                    }
                });
                return { ...p, mesai: m, yolluk: y, toplam: m + y };
            });

            this.db.kayitlar.filter(k => k.durum === "OnaylandÄ±" && k.tarih === hedefAy).forEach(k => {
                ayinToplamMesaisi += (k.mTotal || k.toplamMesai);
                ayinToplamYollugu += (k.yTotal || k.toplamYolluk);
            });

            if(document.getElementById('month-totals')) {
                document.getElementById('month-totals').innerHTML = 
                    `<span style="color:var(--warning)">TOPLAM YOLLUK: ${ayinToplamYollugu.toFixed(2)} TL</span> | ` + 
                    `<span style="color:var(--accent)">TOPLAM MESAÄ°: ${ayinToplamMesaisi.toFixed(2)} TL</span>`;
            }

            const sortType = document.getElementById('sort-filtre') ? document.getElementById('sort-filtre').value : 'yolluk-az';
            
            hakedisVerisi.sort((a, b) => {
                if (sortType === 'yolluk-az') return a.yolluk - b.yolluk;
                if (sortType === 'yolluk-cok') return b.yolluk - a.yolluk;
                if (sortType === 'isim-az') return a.ad.localeCompare(b.ad);
                return a.toplam - b.toplam;
            });

            const stats = { "GÃ¼mrÃ¼k": [], "Muhafaza": [], "KÄ°M": [] };
            hakedisVerisi.forEach(d => {
                if(stats[d.birim]) {
                    stats[d.birim].push(`<tr>
                        <td>${d.sicil||'-'}</td>
                        <td>${d.ad}</td>
                        <td>${d.unvan}</td>
                        <td style="color:var(--accent)">${d.mesai.toFixed(2)} TL</td>
                        <td style="color:var(--warning)">${d.yolluk.toFixed(2)} TL</td>
                        <td style="color:var(--success); font-weight:bold">${d.toplam.toFixed(2)} TL</td>
                    </tr>`);
                }
            });
            document.getElementById('stats-gumruk').innerHTML = stats["GÃ¼mrÃ¼k"].join('') || '<tr><td colspan="6" style="text-align:center">Veri Yok</td></tr>';
            document.getElementById('stats-muhafaza').innerHTML = stats["Muhafaza"].join('') || '<tr><td colspan="6" style="text-align:center">Veri Yok</td></tr>';
            document.getElementById('stats-kim').innerHTML = stats["KÄ°M"].join('') || '<tr><td colspan="6" style="text-align:center">Veri Yok</td></tr>';

            if (document.getElementById('p-manage-body')) {
                document.getElementById('p-manage-body').innerHTML = this.db.personeller.map((p,i)=>`<tr><td><input value="${p.sicil}" onchange="app.db.personeller[${i}].sicil=this.value;app.save()"></td><td><input value="${p.ad}" onchange="app.db.personeller[${i}].ad=this.value;app.save()"></td><td><select onchange="app.db.personeller[${i}].unvan=this.value;app.save()">${this.unvanlar.map(u=>`<option ${p.unvan==u?'selected':''}>${u}</option>`).join('')}</select></td><td><button onclick="app.db.personeller.splice(${i},1);app.save()">X</button></td></tr>`).join('');
            }
            if (document.getElementById('acc-list-body')) {
                document.getElementById('acc-list-body').innerHTML = this.db.accounts.map((a, i) => `<tr><td><input value="${a.user}" onchange="app.db.accounts[${i}].user = this.value; app.save();"></td><td><input type="password" value="${a.pass}" onchange="app.db.accounts[${i}].pass = this.value; app.save();"></td><td><b>${a.rol}</b></td><td><button class="btn btn-danger" onclick="app.deleteAccount(${i})">SÄ°L</button></td></tr>`).join('');
            }
            if (document.getElementById('y-list')) {
                document.getElementById('y-list').innerHTML = this.db.yolluklar.map((y,i)=>`<div style="font-size:11px; padding:4px 0; border-bottom:1px solid var(--border);">${y.ad} (${y.tip}) - ${y.tutar} TL <button onclick="app.db.yolluklar.splice(${i},1);app.save()" style="float:right; font-size:9px;">X</button></div>`).join('');
            }

            let filtered = this.db.kayitlar.slice();
            if (this.taskFilter.arama) {
                const term = this.taskFilter.arama.toLowerCase();
                filtered = filtered.filter(k => k.ref.toLowerCase().includes(term) || k.no.toLowerCase().includes(term) || k.personeller.some(p => p.toLowerCase().includes(term)));
            }
            if (this.taskFilter.durum) filtered = filtered.filter(k => k.durum === this.taskFilter.durum);
            if (this.taskFilter.baslangic || this.taskFilter.bitis) {
                filtered = filtered.filter(k => {
                    if (!k.tarih) return false;
                    return (!this.taskFilter.baslangic || k.tarih >= this.taskFilter.baslangic) && (!this.taskFilter.bitis || k.tarih <= this.taskFilter.bitis);
                });
            }
            filtered.reverse();

            document.getElementById('main-list').innerHTML = filtered.map(l => {
                let btns = "";
                const r = this.user.rol;
                const isAdmin = (r === 'Admin');
                const isTamYetkili = ['Admin', 'GÃ¼mrÃ¼k MÃ¼dÃ¼rÃ¼', 'GÃ¼mrÃ¼k MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±'].includes(r);
                const isMemur = (r === 'GÃ¼mrÃ¼k Memuru' || r === 'GÃ¼mrÃ¼k Åefi');
                
                if (isTamYetkili) {
                    if (l.durum !== "OnaylandÄ±") btns += `<button class="btn btn-success" onclick="app.process('${l.ref}','OnaylandÄ±')">ONAYLA</button> `;
                    if (l.durum === "OnaylandÄ±") btns += `<button class="btn btn-primary" onclick="app.printDoc('${l.ref}')">YAZDIR</button> `;
                    btns += `<button class="btn btn-danger" onclick="app.deleteTask('${l.ref}')">SÄ°L/RED</button>`;
                } 
                else if (isMemur) {
                    if(l.durum === "Taslak") btns += `<button class="btn btn-warning" onclick="app.process('${l.ref}','Åef OnayÄ±nda')">HAVALE</button>`;
                    if(l.durum === "OnaylandÄ±") {
                        btns += `<button class="btn btn-primary" onclick="app.printDoc('${l.ref}')">YAZDIR</button> `;
                        btns += `<button class="btn btn-warning" onclick="app.process('${l.ref}','Silme Talebinde')">SÄ°LME TALEP</button>`;
                    }
                }

                const canEditExtra = (l.durum === "OnaylandÄ±" && (isMemur || isTamYetkili));
                let yardirHtml = "";
                const m = l.mTotal || l.toplamMesai;
                const y = l.yTotal || l.toplamYolluk;
                if(y > 0) yardirHtml += `<div style="color:var(--warning)">ğŸ’° Y: ${y.toFixed(2)}</div>`;
                if(m > 0) yardirHtml += `<div style="color:var(--accent)">â° M: ${m.toFixed(2)}</div>`;
                if(!yardirHtml) yardirHtml = "0.00 TL";

                return `<tr>
                    <td><b>${l.ref}</b></td><td>${l.no}</td>
                    <td>${l.personeller.map(p=>`<span class="tag">${p}</span>`).join('')}</td>
                    <td>${yardirHtml}</td>
                    <td style="color:var(--warning); font-weight:bold">${l.durum}</td>
                    <td>${l.ebys} ${canEditExtra?`<button onclick="app.updateExtra('${l.ref}','EBYS')">âœ</button>`:''}</td>
                    <td>${l.dekont} ${canEditExtra?`<button onclick="app.updateExtra('${l.ref}','Dekont')">âœ</button>`:''}</td>
                    <td>${btns}</td>
                </tr>`;
            }).join('');
        },

        exportSummaryExcel() {
            const hedefAy = this.seciliAy || this.mevcutAy();
            const hakedisVerisi = this.db.personeller.map(p => {
                let m = 0, y = 0;
                this.db.kayitlar.filter(k => k.durum === "OnaylandÄ±" && k.tarih === hedefAy).forEach(k => {
                    if (k.personeller.includes(p.ad)) {
                        m += (k.mTotal || k.toplamMesai) / k.personelSayisi;
                        y += (k.yTotal || k.toplamYolluk) / k.personelSayisi;
                    }
                });
                return { ...p, mesai: m, yolluk: y, toplam: m + y };
            });

            const sortType = document.getElementById('sort-filtre') ? document.getElementById('sort-filtre').value : 'yolluk-az';
            hakedisVerisi.sort((a, b) => {
                if (sortType === 'yolluk-az') return a.yolluk - b.yolluk;
                if (sortType === 'yolluk-cok') return b.yolluk - a.yolluk;
                if (sortType === 'isim-az') return a.ad.localeCompare(b.ad);
                return a.toplam - b.toplam;
            });

            const excelData = hakedisVerisi.map(p => ({
                "Birim": p.birim, "Sicil": p.sicil, "Ad Soyad": p.ad, "Unvan": p.unvan,
                "Toplam Yolluk": p.yolluk.toFixed(2), "Toplam Mesai": p.mesai.toFixed(2), "Genel Toplam": p.toplam.toFixed(2)
            }));
            const ws = XLSX.utils.json_to_sheet(excelData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ozet_Hakedis"); XLSX.writeFile(wb, `Ozet_Hakedis_${hedefAy}.xlsx`);
        },

        exportTaskListExcel() {
            const data = this.db.kayitlar.map(k => ({
                "Referans": k.ref, "Evrak No": k.no, "Personeller": k.personeller.join(", "),
                "Yolluk TutarÄ±": (k.yTotal || k.toplamYolluk), "Mesai TutarÄ±": (k.mTotal || k.toplamMesai),
                "Genel Toplam": ((k.yTotal || k.toplamYolluk) + (k.mTotal || k.toplamMesai)), "Durum": k.durum,
                "EBYS": k.ebys, "Dekont": k.dekont, "Tarih": k.tarih
            }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Gorev_Listesi"); XLSX.writeFile(wb, "Detayli_Gorev_Listesi.xlsx");
        }
    };

    app.checkSession();
    setTimeout(() => { app.loadFromCloud(); }, 500);
  </script>
</body>
</html>
